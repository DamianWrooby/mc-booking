name: Code Review for PRs

on:
  pull_request:
    branches: [master]
    types: [labeled]

jobs:
  code-review:
    if: contains(github.event.label.name, 'claude-code-review')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code

      - name: Comment PR with Claude Code Review
        if: ${{ github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: claude-code-review
          message: ðŸ”Ž Code Review w trakcie...

      - name: Run Claude Code Review
        run: |
          CLAUDE_CR_PROMPT=$(cat .ai/prompts/code-review.md)
          
          CHANGED_FILES=$(git diff --name-only origin/master...HEAD | \
            grep -E '\.(ts|tsx|js|jsx|py|go|java|cs)$' | \
            grep -v 'package-lock.json\|yarn.lock\|dist/\|build/' | \
            head -15)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "# Code Review" > claude-review.md
            echo "" >> claude-review.md
            echo "â„¹ï¸ Brak plikÃ³w do przeglÄ…du." >> claude-review.md
            exit 0
          fi
          
          echo "# Code Review" > claude-review.md
          echo "" >> claude-review.md
          echo "PrzeglÄ…d $(echo "$CHANGED_FILES" | wc -l) plikÃ³w" >> claude-review.md
          echo "" >> claude-review.md
          
          for file in $CHANGED_FILES; do
            echo "Reviewing: $file"
            FILE_DIFF=$(git diff origin/master...HEAD -- "$file")
            DIFF_SIZE=${#FILE_DIFF}
            
            if [ "$DIFF_SIZE" -gt 50000 ]; then
              echo "## ðŸ“„ $file" >> claude-review.md
              echo "*PominiÄ™to - plik zbyt duÅ¼y ($DIFF_SIZE znakÃ³w)*" >> claude-review.md
              echo "" >> claude-review.md
              continue
            fi
            
            echo "## ðŸ“„ $file" >> claude-review.md
            echo "$FILE_DIFF" | claude --append-system-prompt "$CLAUDE_CR_PROMPT" >> claude-review.md 2>&1 || \
              echo "*BÅ‚Ä…d podczas review tego pliku*" >> claude-review.md
            echo "" >> claude-review.md
          done
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Comment PR with Claude Code Review
        if: ${{ github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: claude-code-review
          path: claude-review.md

